#!/bin/bash -leu

export HAWKINS_CACHE_PATH=$PWD/cache/$HAWKINS_REPOSITORY_NAME
export HAWKINS_BUILD_PATH=$PWD/builds/$HAWKINS_REPOSITORY_NAME/$HAWKINS_BUILD

if test -d $HAWKINS_CACHE_PATH; then
  cd $HAWKINS_CACHE_PATH && git fetch -q --all -p
else
  git clone --mirror $HAWKINS_REPOSITORY_URL $HAWKINS_CACHE_PATH
fi

test -d $HAWKINS_BUILD_PATH && rm -R $HAWKINS_BUILD_PATH
git clone --branch $HAWKINS_BRANCH $HAWKINS_CACHE_PATH $HAWKINS_BUILD_PATH
cd $HAWKINS_BUILD_PATH && git reset --hard $HAWKINS_REVISION

trap "rm -fR $HAWKINS_BUILD_PATH" EXIT
chmod +x $HAWKINS_BUILD_PATH/Hawkfile && $HAWKINS_BUILD_PATH/Hawkfile
